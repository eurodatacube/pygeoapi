{% extends "base.html" %}
{% macro literalInputTD(data, prop, itemprop, datalabel) -%}
  <td itemprop="{{ itemprop }}" data-label="{{ datalabel }}">
    {% if prop == 'dataType' %}
      <a target="_blank" title="Type definition" href="http://www.w3.org/2001/XMLSchema#{{ data[prop] }}">
        {{ data[prop] }}
      </a>
    {% else  %}
      {{ data.get(prop, '') }}
    {% endif %}
  </td>
{%- endmacro %}
{% macro occurences(min, max) -%}
  <span>
  {% if min == max %}
    {{ min }}
  {% else %}
    {{min}}â€“{{max}}
  {% endif %}
  </span>
{%- endmacro %}
{% block form_js %}
<script src="{{ config['server']['url'] }}/static/js/postJob.js"></script>
{% endblock %}
{% block title %}{{ super() }} {{ data['title'] }} {% endblock %}
{% block crumbs %}{{ super() }}
/ <a href="../processes">Processes</a>
/ <a href="./{{ data['id'] }}">{{ data['title'] }}</a>
{% endblock %}
{% block body %}
    <section id="process" itemscope itemtype="https://schema.org/WebAPI">
      <h2 itemprop="name">{{ data['title'] }}</h2>
      <p itemprop="keywords">
          {% for kw in data['keywords'] %}
            <mark class="tag">{{ kw }}</mark>
          {% endfor %}
      </p>
      <div itemprop="description">{{data.description}}</div>
      <meta itemprop="url" content="{{config.server.url}}/processes/{{data.id}}" />
      <div class="row">
        <div class="col-sm-12 col-md-12">
          <table class="striped hoverable">
            <caption>Inputs</caption>
            <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Description</th>
              <th>Data Type</th>
              <th>Default Value</th>
              <th>Unit of Measure</th>
              <th>Occurences</th>
              <th>Keywords</th>
            </tr>
            </thead>
            <tbody>
              {% for input_ in data['inputs'] %}
              <tr itemprop="parameter" itemscope>
                <td itemprop="id" data-label="ID">
                  {{ input_.id }}
                </td>
                <td itemprop="name" data-label="Title">
                  {{ input_.title|striptags|truncate }}
                </td>
                <td itemprop="description" data-label="Description">
                  {{ input_.abstract }}
                </td>
                {% if input_.input.literalDataDomain %}
                  {{ literalInputTD(input_.input.literalDataDomain, 'dataType', 'dataType', 'Data Type') }}
                  {{ literalInputTD(input_.input.literalDataDomain.valueDefinition, 'defaultValue', '', 'Default Value') }}
                  {{ literalInputTD(input_.input.literalDataDomain.valueDefinition, 'uom', '', 'Unit of Measure') }}
                {% else %}
                  <td></td>
                  <td></td>
                  <td></td>
                {% endif %}
                <td data-label="Occurences">
                  {{ occurences(
                    input_.get('minOccurs', 1),
                    input_.get('maxOccurs', 'n')
                  ) }}
                </td>
                <td data-label="Keywords">
                  {% for kw in input_.get('keywords', []) %}
                    <mark class="tag">{{ kw }}</mark>
                  {% endfor %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="col-sm-12 col-md-6">
          <table class="striped hoverable">
            <caption>Outputs</caption>
            <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Description</th>
            </tr>
            </thead>
            <tbody>
              {% for output_ in data['outputs'] %}
              <tr itemprop="parameter" itemscope>
                <td itemprop="id" data-label="ID">{{ output_['id'] }}</td>
                <td itemprop="name" data-label="Title">{{ output_['title'] }}</td>
                <td itemprop="description" data-label="Description">
                  {{ output_['description'] | striptags | truncate }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <h3>Execution modes</h3>
          <ul>
            {% if 'sync-execute' in data.jobControlOptions %}<li>Synchronous</li>{% endif %}
            {% if 'async-execute' in data.jobControlOptions %}<li>Asynchronous</li>{% endif %}
          </ul>
          <h2>Links</h2>
          <ul>
            {% for link in data['links'] %}
                <li>
                <!-- TODO put links in head as Links as well? -->
                  <span class="icon-link"></span>
                  <a title={{link.title}} type={{link.type}} rel={{link.rel}} href={{link.href}} hreflang={{link.hreflang}}>
                    {{ link['title'] }} ({{ link['type'] }})
                  </a>
                </li>
            {% endfor %}
          </ul>
        </div>
        <div class="col-sm-12 col-md-6">
          <section id='process-example input-group'>
            <form class="form-style-1" onsubmit="return submitJob('{{config.server.url}}/processes/{{data.id}}/jobs');" method="POST">
              <h2>Submit a job</h2>
              <li>
                <!-- TODO placeholder with description -->
                <!-- TODO infer type from metadata -->
                <!-- TODO radio for enum -->
                <!-- TODO max/min for numbers -->
                {% set typeMap = {'string': 'text', 'integer': 'number', 'float': 'number', 'boolean': 'checkbox', 'enum': 'radio'} %}
                {% for input_ in data['inputs'] %}
                  <label for={{input_.id}}>{{input_.title|striptags|truncate}}{% if input_.get('minOccurs', 1) > 0 %}*{% endif %} </label>
                  {% if input_.input.literalDataDomain %}
                    {% set example = data.example.inputs|selectattr("id","equalto",input_.id)|first|default("none") %}
                    {% set rawType = input_.input.literalDataDomain.dataType %}
                    {% set formType = typeMap[rawType] %}
                    {% set defaultValue = input_.input.literalDataDomain.valueDefinition.defaultValue|default("") %}
                    {% if formType != 'radio' %}
                      <input
                        class="job-form-input"
                        type="{{formType}}"
                        name={{input_.id}}
                        id={{input_.id}}
                        title="{{input_.abstract|striptags}}"
                        {% if type == 'string' %}
                          autocomplete="off"
                        {% endif %}
                        {% if formType != 'checkbox' %}
                          placeholder="{{example.value|default('')}}"
                          value="{{defaultValue or null}}"
                        {% endif %}
                        {% if rawType == 'integer' %}
                          step="1"
                        {% elif rawType == 'float' %}
                          step="0.1"
                        {% endif %}
                        {% if (formType == 'checkbox') and (defaultValue is sameas true) %}
                          checked="checked"
                        {% endif %}
                        {% if (input_.get('minOccurs', 1) > 0) %}
                          required="required"
                        {% endif %}
                      >
                    {% else %}
                      {% for value in input_.input.literalDataDomain.valueDefinition.possibleValues %}
                        <input
                          type={{formType}}
                          name={{input_.id}}
                          id={{value|striptags}}
                          title="{{input_.abstract|striptags}}"
                          name={{value}}
                          value={{value}}
                          {% if input_.input.literalDataDomain.valueDefinition.defaultValue == value %}
                          checked="checked"
                          {% endif %}
                        >
                        <label for={{value|striptags}}>{{value}}</label>
                        <br/>
                      {% endfor %}
                    {% endif %}
                  {% elif input_.input.formats %}
                    {% set accept = input_.input.formats|map(attribute='mimeType')|join(',') %}
                    <input
                      class="job-form-input"
                      type="file"
                      id={{input_.id}}
                      name={{input_.id}}
                      accept={{accept}}
                      title="{{input_.abstract|striptags}}"
                      {% if (input_.get('maxOccurs', 2) > 1) %}
                      multiple="multiple"
                      {% endif %}
                      {% if (input_.get('minOccurs', 0) > 0) %}
                      required="required"
                      {% endif %}
                    >
                  {% endif %}
                {% endfor %}
              </li>
              <li>
                <div class="button-group">
                  <input type="submit" onclick="submitButtonClick(this)" name="sync" title="Synchronous processing" value="Process now" class="shadowed">
                  <input type="submit" onclick="submitButtonClick(this)" name="async" title="Asynchronous processing" value="Add to queue" class="shadowed">
                  <input type="reset" class="shadowed" title="Return all fields to their default values" value="Reset form">
                <div>
              </li>
            </form>
            <section class="callout-info" id="job-results"></section>
          </section>
        </div>
      </div>
    </section>

{% endblock %}
